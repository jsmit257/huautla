---

event:
  all-by-lifecycle: >
    select e.uuid,
           e.temperature,
           e.humidity,
           e.mtime,
           e.ctime,
           et.uuid as eventtype_uuid,
           et.name as eventtype_name,
           et.severity as eventtype_severity,
           s.uuid as stage_uuid,
           s.name as stage_name
      from events e
      join event_types et
        on e.eventtype_uuid = et.uuid
      join stages s
        on et.stage_uuid = s.uuid
     where lifecycle_uuid = ?
     order
        by mtime
  all-by-eventtype: >
    select e.uuid,
           e.temperature,
           e.humidity,
           e.mtime,
           e.ctime,
           et.uuid as eventtype_uuid,
           et.name as eventtype_name,
           et.severity as eventtype_severity,
           s.uuid as stage_uuid,
           s.name as stage_name
      from events e
      join event_types et
        on e.eventtype_uuid = et.uuid
      join stages s
        on et.stage_uuid = s.uuid
     where et.uuid = ?
  select: >
    select e.temperature,
           e.humidity,
           e.mtime,
           e.ctime,
           et.uuid as eventtype_uuid,
           et.name as eventtype_name,
           et.severity as eventtype_severity,
           s.uuid as stage_uuid,
           s.name as stage_name
      from events e
      join event_types et
        on e.eventtype_uuid = et.uuid
      join stages s
        on et.stage_uuid = s.uuid
     where e.uuid = ?
  add: >
    insert
      into events(uuid, temperature, humidity, mtime, ctime, lifecycle_uuid, eventtype_uuid)
    select ?, ?, ?, ?, ?, lc.uuid, et.uuid
      from lifecycle lc,
           event_types et
     where lc.uuid = ?
       and et.uuid = ?
  change: >
    update events
       set temperature = ?,
           humidity = ?,
           mtime = ?,
           eventtype_uuid = et.uuid
      from event_types et
     where event.uuid = ?
       and et.uuid = ?
  remove: delete from events where uuid = ?

eventtype:
  select-all: >
    select e.uuid,
           e.name,
           e.severity,
           s.uuid as stage_uuid,
           s.name as stage_name
      from event_types e
      join stages s
        on e.stage_uuid = s.uuid
  select:
    select e.name,
           e.severity,
           s.uuid as stage_uuid,
           s.name as stage_name
      from event_types e
      join stages s
        on e.stage_uuid = s.uuid
     where e.uuid = ?
  insert: >
    insert
      into event_types(uuid, name, severity, stage_uuid)
    select ?,
           ?,
           ?,           
           s.uuid
      from stages s
     where s.uuid = ?
  update: update event_types set name = ? where uuid = ?
  delete: delete from event_types where uuid = ?

ingredient:
  select-all: select uuid, name from ingredients order by name
  select: select name from ingredients where uuid = ?
  insert: insert into ingredients(uuid, name) values(?, ?)
  update: update ingredients set name = ? where uuid = ?
  delete: delete from ingredients where uuid = ?

lifecycle:
  # it's an ugly, bad precedent, except that it saves a lot of hits to the db
  select: >
    select lc.name,
           lc.location,
           lc.grain_cost,
           lc.bulk_cost,
           lc.yield,
           lc.headcount,
           lc.gross,
           lc.mtime,
           lc.ctime,
           s.uuid as strain_uuid,
           s.name as strain_name,
           sv.uuid as strain_vendor_uuid,
           sv.name as strain_vendor_name,
           gs.uuid as grain_substrate_uuid,
           gs.name as grain_substrate_name,
           gs.type as grain_substrate_type,
           gv.uuid as grain_vendor_uuid,
           gv.name as grain_vendor_name,
           bs.uuid as bulk_substrate_uuid,
           bs.name as bulk_substrate_name,
           bs.type as bulk_substrate_type,
           bv.uuid as bulk_vendor_uuid,
           bv.name as bulk_vendor_name
      from lifecycles lc
      join strains s
        on lc.strain_uuid = s.uuid
      join vendors sv
        on s.vendor_uuid = sv.uuid
      join substrates gs
        on lc.grainsubstrate_uuid = gs.uuid
      join vendors gv
        on gs.vendor_uuid = gv.uuid
      join substrates bs
        on lc.bulksubstrate_uuid = bs.uuid
      join vendors bv
        on bs.vendor_uuid = bv.uuid
     where lc.uuid = ?
  insert: >
    insert
      into lifecycles(
           uuid,
           name,
           location,
           grain_cost,
           bulk_cost,
           yield,
           headcount,
           gross,
           mtime,
           ctime,
           strain_uuid,
           grainsubstrate_uuid,
           bulksubstrate_uuid)
    select ?,
           ?,
           ?,
           ?,
           ?,
           ?,
           ?,
           ?,
           ?,
           ?,
           s.uuid,
           gs.uuid,
           bs.uuid
      from strains s,
           substrates gs,
           substrates bs
     where s.uuid = ?
       and gs.uuid = ?
       and gs.type = 'Grain'
       and bs.uuid = ?
       and gs.type = 'Bulk'
  update: >
    update lifecycles
       set name = ?,
           location = ?,
           grain_cost = ?,
           bulk_cost = ?,
           yield = ?,
           headcount = ?,
           gross = ?,
           mtime = ?,
           strain_uuid = s.uuid,
           grainsubstrate_uuid = gs.uuid,
           bulksubstrate_uuid = bs.uuid
      from strains s,
           substrates gs,
           substrates bs
     where s.uuid = ?
       and gs.uuid = ?
       and gs.type = 'Grain'
       and bs.uuid = ?
       and gs.type = 'Bulk'
  delete: delete from lifecycles where uuid = ?

stage:
  select-all: select uuid, name from stages order by name
  select: select name from stages where uuid = ?
  insert: insert into stages(uuid, name) values(?, ?)
  update: update stages set name = ? where uuid = ?
  delete: delete from stages where uuid = ?

strain:
  select-all: >
    select s.name,
           v.uuid as vendor_uuid,
           v.name as vendor_name
      from strains s
      join vendors v
        on s.vendor_uuid = v.uuid
     order
        by s.name
  select: >
    select s.name,
           v.uuid as vendor_uuid,
           v.name as vendor_name
      from strains s
      join vendors v
        on s.vendor_uuid = v.uuid
     where s.uuid = ?
  insert: >
    insert
      into strains(uuid, name, vendor_uuid)
    select ?, ?, v.uuid
      from vendors v
     where vendor_uuid = ?
  update: update strains set name = ? where uuid = ?
  delete: delete from strains where uuid = ?

strainattribute:
  get-unique-names: select distinct name from strain_attributes order by name
  all: >
    select uuid, name, value
      from strain_attributes sa
     where strain_uuid = ?
  add: >
    insert
      into strain_attributes (uuid, name, value, strain_uuid)
    select ?, ?, ?, s.uuid
      from strains s
     where s.uuid = ?
  change: >
    update strain_attributes sa
       set value = ?
      from strains s
     where sa.name = ?
       and s.uuid = ?
  remove: >
    delete from strain_attributes where uuid = ?

substrate-ingredient:
  all: >
    select i.uuid,
           i.name
      from ingredients i
      join substrate_ingredients si
        on i.uuid = si.ingredient_uuid
     where si.substrate_uuid = ?
  add: >
    insert
    into substrate_ingredients (uuid, substrate_uuid, ingredient_uuid)
    select ?, s.uuid, i.uuid
      from substrates s,
           ingredients i
     where s.uuid = ?
       and i.uuid = ?
  change: >
    update substrate_ingredients
       set ingredient_uuid = ?
     where substrate_uuid = ?
       and ingredient_uuid = ?
  remove: >
    delete
      from substrate_ingredients
     where substrate_uuid = ?
       and ingredient_uuid = ?

substrate:
  select-all: >
    select s.name,
           v.uuid as vendor_uuid,
           v.name as vendor_name
      from substrates s
      join vendors v
        on s.vendor_uuid = v.uuid
     order
        by s.name
  select: >
    select s.name,
           v.uuid as vendor_uuid,
           v.name as vendor_name
      from substrates s
      join vendors v
        on s.vendor_uuid = v.uuid
     where s.uuid = ?
  insert: >
    insert
      into substrates(uuid, name, type, vendor_uuid)
    select ?, ?, ?, v.uuid
      from vendors v
     where v.uuid = ?
  update: update substrates set name = ? where uuid = ?
  delete: delete from substrates where uuid = ?

vendor:
  select-all: select uuid, name from vendors order by name
  select: select name from vendors where uuid = ?
  insert: insert into vendors(uuid, name) values(?, ?)
  update: update vendors set name = ? where uuid = ?
  delete: delete from vendors where uuid = ?
